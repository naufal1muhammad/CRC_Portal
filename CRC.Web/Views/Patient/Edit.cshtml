@{
    ViewData["Title"] = "Patient";
    Layout = "_Layout";

    var patientId = (string)(ViewData["PatientId"] ?? string.Empty);
}

<div class="container-fluid py-3" data-patient-id="@patientId">

    <!-- Header -->
    <div class="d-flex align-items-center mb-3">
        <div>
            <h2 id="patientHeaderName" class="mb-0">Patient: -</h2>
            <small id="patientHeaderId" class="text-muted">
                @if (string.IsNullOrEmpty(patientId))
                {
                    @:New Patient (ID will be generated on save)
                }
                else
                {
                    @:ID: @patientId
                }
            </small>
        </div>

        <div class="ms-auto">
            <a asp-action="Active" asp-controller="Patient"
               class="btn btn-sm btn-outline-secondary me-2">
                <i class="fas fa-arrow-left me-1"></i> Back to Active Patients List
            </a>
            <a asp-action="Discharged" asp-controller="Patient"
               class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i> Back to Discharged Patients List
            </a>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="patientEditTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="tab-basic-details"
                    data-bs-toggle="tab"
                    data-bs-target="#tabBasicDetails"
                    type="button"
                    role="tab">
                Basic Details
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="tab-appointment"
                    data-bs-toggle="tab"
                    data-bs-target="#tabAppointment"
                    type="button"
                    role="tab">
                Appointment
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="tab-journey"
                    data-bs-toggle="tab"
                    data-bs-target="#tabPatientJourney"
                    type="button"
                    role="tab">
                Patient Journey
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="tab-documents"
                    data-bs-toggle="tab"
                    data-bs-target="#tabDocuments"
                    type="button"
                    role="tab">
                Documents
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="tab-discharge-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-discharge"
                    type="button"
                    role="tab">
                Discharge
            </button>
        </li>
    </ul>

    <!-- Tab contents -->
    <div class="tab-content border border-top-0 p-3 bg-white" id="patientEditTabContent">

        <!-- Basic Details tab -->
        <div class="tab-pane fade show active"
             id="tabBasicDetails"
             role="tabpanel"
             aria-labelledby="tab-basic-details">
            <div id="basicDetailsContent">
                <input type="hidden" id="PatientIdHidden" value="@patientId" />

                <div class="row g-3">
                    <!-- Left column -->
                    <div class="col-lg-6">

                        <div class="mb-2">
                            <label for="PatientName" class="form-label">Name <span class="text-danger">*</span></label>
                            <input id="PatientName" type="text" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientEmail" class="form-label">Email <span class="text-danger">*</span></label>
                            <input id="PatientEmail" type="email" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientPhone" class="form-label">Phone Number <span class="text-danger">*</span></label>
                            <input id="PatientPhone" type="text" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientNRIC" class="form-label">NRIC Number <span class="text-danger">*</span></label>
                            <input id="PatientNRIC" type="text" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientAdmittedOn" class="form-label">Admitted On <span class="text-danger">*</span></label>
                            <input id="PatientAdmittedOn" type="date" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientBirthDate" class="form-label">Birth Date <span class="text-danger">*</span></label>
                            <input id="PatientBirthDate" type="date" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientAge" class="form-label">Age <span class="text-danger">*</span></label>
                            <input id="PatientAge" type="number" class="form-control form-control-sm" readonly />
                            <div class="form-text">Automatically calculated from Birth Date.</div>
                        </div>

                        <div class="mb-2">
                            <label for="PatientGender" class="form-label">Gender <span class="text-danger">*</span></label>
                            <select id="PatientGender" class="form-select form-select-sm">
                                <option value="">-- Select Gender --</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientRace" class="form-label">Race <span class="text-danger">*</span></label>
                            <select id="PatientRace" class="form-select form-select-sm">
                                <option value="">-- Select Race --</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientSource" class="form-label">Source <span class="text-danger">*</span></label>
                            <select id="PatientSource" class="form-select form-select-sm">
                                <option value="">-- Select Source --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Right column -->
                    <div class="col-lg-6">

                        <div class="mb-2">
                            <label for="PatientBranch" class="form-label">Branch <span class="text-danger">*</span></label>
                            <select id="PatientBranch" class="form-select form-select-sm">
                                <option value="">-- Select Branch --</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientReligion" class="form-label">Religion <span class="text-danger">*</span></label>
                            <select id="PatientReligion" class="form-select form-select-sm">
                                <option value="">-- Select Religion --</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientMaritalStatus" class="form-label">Marital Status <span class="text-danger">*</span></label>
                            <select id="PatientMaritalStatus" class="form-select form-select-sm">
                                <option value="">-- Select Marital Status --</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientOccupation" class="form-label">Occupation <span class="text-danger">*</span></label>
                            <select id="PatientOccupation" class="form-select form-select-sm">
                                <option value="">-- Select Occupation --</option>
                            </select>
                        </div>

                        <div class="mb-2">
                            <label for="PatientAddress" class="form-label">Address <span class="text-danger">*</span></label>
                            <textarea id="PatientAddress" rows="3" class="form-control form-control-sm"></textarea>
                        </div>

                        <div class="mb-2">
                            <label for="PatientEmergencyName" class="form-label">Emergency Contact Name <span class="text-danger">*</span></label>
                            <input id="PatientEmergencyName" type="text" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientEmergencyRelationship" class="form-label">Emergency Contact Relationship <span class="text-danger">*</span></label>
                            <input id="PatientEmergencyRelationship" type="text" class="form-control form-control-sm" />
                        </div>

                        <div class="mb-2">
                            <label for="PatientEmergencyNumber" class="form-label">Emergency Contact Number <span class="text-danger">*</span></label>
                            <input id="PatientEmergencyNumber" type="text" class="form-control form-control-sm" />
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Appointment tab -->
        <div class="tab-pane fade"
             id="tabAppointment"
             role="tabpanel"
             aria-labelledby="tab-appointment">
            <div id="appointmentContent">
                <div id="appointmentMessage" class="text-danger small mb-2"></div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Appointments</h5>
                    <button id="btnAddAppointment"
                            type="button"
                            class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i> Add Appointment
                    </button>
                </div>

                <div class="table-responsive">
                    <table id="appointmentTable" class="table table-sm table-striped mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>Date &amp; Time</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th style="width: 120px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center text-muted">
                                    No appointments loaded.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Appointment Modal -->
            <div class="modal fade" id="appointmentModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Appointment</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="appointmentModalMessage" class="text-danger small mb-2"></div>

                            <div class="mb-2">
                                <label for="AppointmentDateTime" class="form-label">
                                    Appointment Date &amp; Time <span class="text-danger">*</span>
                                </label>
                                <input id="AppointmentDateTime"
                                       type="datetime-local"
                                       class="form-control form-control-sm" />
                            </div>

                            <div class="mb-2">
                                <label for="AppointmentType" class="form-label">
                                    Appointment Type <span class="text-danger">*</span>
                                </label>
                                <select id="AppointmentType" class="form-select form-select-sm">
                                    <option value="">-- Select Type --</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="AppointmentStatus" class="form-label">
                                    Attendance Status <span class="text-danger">*</span>
                                </label>
                                <select id="AppointmentStatus" class="form-select form-select-sm">
                                    <option value="">-- Select Status --</option>
                                    <option value="Scheduled">Scheduled</option>
                                    <option value="Attended">Attended</option>
                                    <option value="Not Attended">Not Attended</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button"
                                    class="btn btn-sm btn-secondary"
                                    data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    id="btnSaveAppointment">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Journey tab -->
        <div class="tab-pane fade"
             id="tabPatientJourney"
             role="tabpanel"
             aria-labelledby="tab-journey">
            <div id="journeyContent">
                <div id="journeyMessage" class="text-danger small mb-2"></div>

                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Patient Journey</h5>
                    <button id="btnAddJourney"
                            type="button"
                            class="btn btn-sm btn-primary">
                        <i class="fas fa-plus me-1"></i> Add Journey
                    </button>
                </div>

                <div class="table-responsive">
                    <table id="journeyTable" class="table table-sm table-striped mb-0">
                        <thead class="table-secondary">
                            <tr>
                                <th>Date</th>
                                <th>Journey Type</th>
                                <th>Staff</th>
                                <th>Remarks</th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    No journeys loaded.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add Journey Modal -->
            <div class="modal fade" id="journeyModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Journey</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="journeyModalMessage" class="text-danger small mb-2"></div>

                            <div class="mb-2">
                                <label for="JourneyDate" class="form-label">
                                    Date <span class="text-danger">*</span>
                                </label>
                                <input id="JourneyDate"
                                       type="date"
                                       class="form-control form-control-sm" />
                            </div>

                            <div class="mb-2">
                                <label for="JourneyType" class="form-label">
                                    Journey Type <span class="text-danger">*</span>
                                </label>
                                <select id="JourneyType" class="form-select form-select-sm">
                                    <option value="">-- Select Journey Type --</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="JourneyStaff" class="form-label">
                                    Staff Name <span class="text-danger">*</span>
                                </label>
                                <select id="JourneyStaff" class="form-select form-select-sm">
                                    <option value="">-- Select Staff --</option>
                                </select>
                            </div>

                            <div class="mb-2">
                                <label for="JourneyRemarks" class="form-label">
                                    Remarks (optional)
                                </label>
                                <textarea id="JourneyRemarks"
                                          class="form-control form-control-sm"
                                          rows="2"></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button"
                                    class="btn btn-sm btn-secondary"
                                    data-bs-dismiss="modal">
                                Cancel
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-primary"
                                    id="btnSaveJourney">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Documents tab -->
        <div class="tab-pane fade"
             id="tabDocuments"
             role="tabpanel"
             aria-labelledby="tab-documents">
            <div id="documentsContent">
                <div id="documentsMessage" class="text-danger small mb-2"></div>

                <p class="text-muted small mb-2">
                    Upload documents by type. Uploads are saved immediately and do not depend on the main Save button.
                </p>

                <div id="patientDocumentsContainer">
                    <p class="text-muted mb-0">Loading document types...</p>
                </div>
            </div>
        </div>

        <!-- Discharge tab -->
        <div class="tab-pane fade" id="tab-discharge" role="tabpanel" aria-labelledby="tab-discharge-tab">
            <div class="mt-3">

                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="PatientIsDischarged">
                    <label class="form-check-label" for="PatientIsDischarged">
                        Discharge this patient
                    </label>
                </div>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="PatientDischargeDate" class="form-label">
                            Discharge Date <span class="text-danger">*</span>
                        </label>
                        <input type="date"
                               class="form-control form-control-sm"
                               id="PatientDischargeDate" />
                    </div>

                    <div class="col-md-4">
                        <label for="PatientDischargeType" class="form-label">
                            Discharge Type <span class="text-danger">*</span>
                        </label>
                        <select class="form-select form-select-sm"
                                id="PatientDischargeType">
                            <option value="">-- Select Discharge Type --</option>
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label for="PatientDischargeRemarks" class="form-label">
                            Remarks
                        </label>
                        <textarea class="form-control form-control-sm"
                                  id="PatientDischargeRemarks"
                                  rows="2"></textarea>
                    </div>
                </div>

                <div id="dischargeTabMessage" class="small text-danger mt-2"></div>
            </div>
        </div>
    </div>

    <div id="basicDetailsMessage" class="text-danger small mb-2"></div>
    <!-- Global Save button for Basic + Discharge -->
    <div class="mt-3 d-flex justify-content-end">
        <button id="btnSavePatientMain"
                type="button"
                class="btn btn-primary">
            <i class="fas fa-save me-1"></i> Save
        </button>
    </div>

    <!-- Save Success Modal -->
    <div class="modal fade" id="saveSuccessModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content text-center p-4">
                <div class="modal-body">
                    <div class="display-3 text-success mb-3">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <h5 class="mb-2">Saved Successfully</h5>
                    <p class="text-muted mb-3">Patient details have been saved.</p>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script src="~/js/patient/edit-basic.js"></script>
    <script src="~/js/patient/edit-appointment.js"></script>
    <script src="~/js/patient/edit-journey.js"></script>
    <script src="~/js/patient/edit-documents.js"></script>
    <script src="~/js/patient/edit-discharge.js"></script>
}